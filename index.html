<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grass and Grit Farms - Goat Herd Tracker</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lato:wght@300;400;500;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --barn-red: #8b3a3a;
            --field-green: #5a7a54;
            --wheat-gold: #d4a574;
            --cream: #f5f1e8;
            --dark-brown: #3d2817;
            --light-tan: #e8dcc4;
        }
        
        body {
            font-family: 'Lato', sans-serif;
            background: linear-gradient(to bottom, #f5f1e8 0%, #e8dcc4 100%);
            color: var(--dark-brown);
            min-height: 100vh;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            overflow-x: hidden;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            font-weight: 700;
            color: var(--barn-red);
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: var(--field-green);
            font-weight: 400;
        }
        
        /* Google Sheets Sync Styles */
        .sync-controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .sync-status {
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .sync-status.success { background: #d4edda; color: #155724; }
        .sync-status.syncing { background: #fff3cd; color: #856404; }
        .sync-status.error { background: #f8d7da; color: #721c24; }
        .sync-status.offline { background: #e2e3e5; color: #383d41; }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--field-green);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--barn-red);
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--light-tan);
            flex-wrap: wrap;
            overflow-x: auto;
        }
        
        .tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-brown);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .tab:hover { color: var(--barn-red); }
        .tab.active { color: var(--barn-red); border-bottom-color: var(--barn-red); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            margin-bottom: 25px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .card-header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .card-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark-brown);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s;
            font-family: 'Lato', sans-serif;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .btn-primary { background: var(--barn-red); color: white; }
        .btn-primary:hover { background: #6d2e2e; transform: translateY(-1px); }
        .btn-secondary { background: var(--field-green); color: white; }
        .btn-secondary:hover { background: #4a6245; }
        .btn-danger { background: #c44; color: white; }
        .btn-danger:hover { background: #a33; }
        .btn-small { padding: 8px 16px; font-size: 0.85rem; }
        
        .search-filters {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--light-tan);
            border-radius: 6px;
            font-size: 1rem;
            font-family: 'Lato', sans-serif;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--field-green);
        }
        
        table { width: 100%; border-collapse: collapse; }
        
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 20px;
        }
        
        thead { background: var(--barn-red); color: white; }
        
        th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        th.sortable {
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            position: relative;
            padding-right: 30px;
            transition: background 0.2s;
            touch-action: manipulation;
            min-height: 44px;
        }
        
        th.sortable:hover { background: rgba(255,255,255,0.1); }
        th.sortable::after { content: '‚áÖ'; position: absolute; right: 10px; opacity: 0.4; font-size: 1rem; }
        th.sortable.asc::after { content: '‚ñ≤'; opacity: 1; }
        th.sortable.desc::after { content: '‚ñº'; opacity: 1; }
        
        td { padding: 15px 12px; border-bottom: 1px solid var(--light-tan); }
        tbody tr:hover { background: #faf8f3; }
        
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .badge-active { background: #d4edda; color: #155724; }
        .badge-sold { background: #d1ecf1; color: #0c5460; }
        .badge-culled { background: #f8d7da; color: #721c24; }
        .badge-deceased { background: #e2e3e5; color: #383d41; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            margin-bottom: 25px;
            color: var(--dark-brown);
        }
        
        .close-modal {
            position: absolute;
            top: 20px; right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: var(--dark-brown);
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }
        
        .close-modal:hover { color: var(--barn-red); }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group { display: flex; flex-direction: column; }
        
        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-brown);
            font-size: 0.95rem;
        }
        
        textarea { min-height: 100px; resize: vertical; }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        .checkbox-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        
        .info-box {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 4px solid var(--field-green);
        }
        
        .detail-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 2px solid var(--light-tan);
        }
        
        .detail-section:last-child { border-bottom: none; }
        
        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--barn-red);
        }
        
        .section-title.foundation {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--field-green), #4a6245);
            color: white;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 3px 10px rgba(90, 122, 84, 0.3);
        }
        
        .section-title.foundation::before { content: "üå±"; font-size: 1.3rem; }
        
        .section-title.family-groups {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--wheat-gold), #c49565);
            color: white;
            border-radius: 10px;
            margin: 30px 0 25px 0;
            box-shadow: 0 3px 10px rgba(212, 165, 116, 0.3);
        }
        
        .section-title.family-groups::before { content: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶"; font-size: 1.3rem; }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .detail-item { display: flex; flex-direction: column; gap: 5px; }
        
        .detail-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--field-green);
            font-weight: 600;
        }
        
        .detail-value { font-size: 1.1rem; color: var(--dark-brown); }
        
        .family-tree { background: #f9f7f3; padding: 25px; border-radius: 8px; }
        .tree-level { margin-bottom: 25px; }
        
        .tree-title {
            font-weight: 600;
            color: var(--field-green);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }
        
        .tree-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .tree-box {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--barn-red);
        }
        
        .weight-records { background: #f9f7f3; padding: 20px; border-radius: 8px; }
        
        .weight-entry {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--field-green);
        }
        
        .action-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .photo-upload-container { text-align: center; margin-bottom: 20px; }
        
        .photo-preview {
            width: 200px;
            height: 200px;
            border-radius: 12px;
            object-fit: cover;
            margin: 15px auto;
            display: block;
            border: 3px solid var(--light-tan);
        }
        
        .photo-upload-btn { position: relative; overflow: hidden; display: inline-block; }
        .photo-upload-btn input[type="file"] { position: absolute; left: -9999px; }
        
        .goat-photo-small {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid var(--light-tan);
        }
        
        .goat-photo-large {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 12px;
            margin: 15px auto;
            display: block;
            border: 3px solid var(--light-tan);
        }
        
        .tree-view-container {
            background: linear-gradient(to bottom, #ffffff 0%, #fafafa 100%);
            padding: 35px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 2px solid var(--light-tan);
        }
        
        .tree-view-container h4 {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            background: linear-gradient(135deg, var(--barn-red), #a04545);
            color: white;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 3px 10px rgba(139, 58, 58, 0.3);
            font-size: 1.1rem;
        }
        
        .tree-view-container h4::before { content: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶"; font-size: 1.4rem; }
        
        .tree-node {
            background: white;
            padding: 20px 25px;
            border-radius: 12px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            min-height: 44px;
        }
        
        .tree-node[data-gender="Doe"] {
            border-left: 5px solid #d98cb9;
            background: linear-gradient(to right, #fef5fa 0%, white 10%);
        }
        
        .tree-node[data-gender="Buck"] {
            border-left: 5px solid #6ba3d4;
            background: linear-gradient(to right, #f0f7fc 0%, white 10%);
        }
        
        .tree-node[data-gender="Wether"] {
            border-left: 5px solid var(--wheat-gold);
            background: linear-gradient(to right, #fdf9f0 0%, white 10%);
        }
        
        .tree-node:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border-color: var(--field-green);
        }
        
        .tree-node-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--barn-red);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tree-node-name::before { content: "üêê"; font-size: 1.3rem; }
        
        .tree-node-details {
            font-size: 1rem;
            color: #555;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-top: 5px;
        }
        
        .tree-node-details > span {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: #f5f5f5;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .tree-node-details .gender-badge { font-weight: 600; padding: 5px 12px; border-radius: 8px; }
        .tree-node-details .gender-badge.doe { background: #d98cb9; color: white; }
        .tree-node-details .gender-badge.buck { background: #6ba3d4; color: white; }
        .tree-node-details .gender-badge.wether { background: var(--wheat-gold); color: white; }
        .tree-node-details .offspring-count { background: var(--field-green); color: white; font-weight: 600; }
        
        .tree-children {
            margin-left: 60px;
            margin-top: 20px;
            padding-left: 30px;
            border-left: 3px solid var(--light-tan);
            position: relative;
        }
        
        .tree-children::before {
            content: "";
            position: absolute;
            left: -3px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, var(--field-green) 0%, var(--light-tan) 100%);
        }
        
        .tree-children > .tree-node::before {
            content: "";
            position: absolute;
            left: -30px;
            top: 50%;
            width: 25px;
            height: 2px;
            background: var(--light-tan);
        }
        
        .tree-children > .tree-node:first-child::after {
            content: "‚Ü≥ Offspring";
            position: absolute;
            left: -55px;
            top: -25px;
            font-size: 0.75rem;
            color: var(--field-green);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .kidding-record { background: #f9f7f3; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .kidding-stat { display: inline-block; padding: 8px 16px; background: white; border-radius: 6px; margin-right: 10px; font-weight: 600; }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 0; }
            header { padding: 20px 15px; margin-bottom: 15px; }
            h1 { font-size: 1.8rem; }
            .subtitle { font-size: 1rem; }
            .stats { grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px; }
            .stat-card { padding: 18px 15px; }
            .stat-label { font-size: 0.75rem; }
            .stat-value { font-size: 2.5rem; }
            
            .tabs {
                flex-wrap: nowrap;
                gap: 0;
                margin-bottom: 10px;
                overflow-x: auto;
                overflow-y: hidden;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                padding-bottom: 0;
            }
            
            .tabs::-webkit-scrollbar { display: none; }
            
            .tab {
                padding: 10px 15px;
                font-size: 0.85rem;
                flex-shrink: 0;
                display: inline-block;
                white-space: nowrap;
                margin-bottom: -2px;
            }
            
            .card { padding: 15px 12px; margin-bottom: 15px; border-radius: 10px; }
            .card-header { flex-direction: column; align-items: stretch; gap: 12px; }
            .card-header-buttons { display: flex; flex-direction: column; gap: 8px; width: 100%; }
            .card-header-buttons .btn { width: 100%; }
            .card-title { font-size: 1.4rem; margin-bottom: 5px; }
            .search-filters { grid-template-columns: 1fr; gap: 8px; margin-bottom: 12px; }
            
            table {
                display: block;
                width: 100%;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                font-size: 0.75rem;
                border: 1px solid var(--light-tan);
                border-radius: 6px;
            }
            
            th, td { padding: 8px 5px; font-size: 0.75rem; vertical-align: middle; }
            
            .btn { padding: 12px 16px; font-size: 0.9rem; width: 100%; }
            .btn-small { padding: 8px 12px; font-size: 0.8rem; width: auto; min-width: 70px; }
            
            .modal { padding: 10px; }
            .modal-content { padding: 20px 15px; max-height: 90vh; margin: 0; border-radius: 10px; }
            .modal-title { font-size: 1.3rem; margin-bottom: 15px; padding-right: 35px; }
            .close-modal { font-size: 1.8rem; top: 12px; right: 12px; padding: 5px; }
            .form-grid { grid-template-columns: 1fr; gap: 12px; }
            input, select, textarea { font-size: 16px; padding: 12px; }
            
            .tree-children { margin-left: 15px; padding-left: 8px; }
            .tree-node { padding: 12px 15px; margin: 8px 0; }
            .tree-node-name { font-size: 1rem; }
            .tree-view-container { padding: 12px; }
            
            .sync-controls { padding: 12px; }
            .sync-controls .btn { min-width: 100px; padding: 10px 15px; font-size: 0.85rem; }
        }
        
        @media (max-width: 576px) {
            body { padding: 5px; }
            h1 { font-size: 1.5rem; }
            header { padding: 15px 10px; }
            .stat-value { font-size: 2rem; }
            .tab { padding: 8px 12px; font-size: 0.8rem; }
            .card { padding: 12px 10px; }
            .card-title { font-size: 1.2rem; }
            th, td { padding: 6px 3px; font-size: 0.7rem; }
            .btn { padding: 10px 12px; font-size: 0.85rem; }
            .btn-small { padding: 6px 10px; font-size: 0.75rem; min-width: 55px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üêê Grass and Grit Farms</h1>
            <p class="subtitle">Goat Herd Tracker</p>
        </header>
        
        <!-- Google Sheets Sync Controls -->
        <div class="sync-controls">
            <div id="syncStatus" class="sync-status success">
                üü¢ Ready to sync with Google Sheets
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button onclick="syncAllToSheets()" class="btn btn-primary" style="min-width: 150px;">
                    üîÑ Sync to Sheets
                </button>
                <button onclick="loadAllFromSheets()" class="btn btn-secondary" style="min-width: 150px;">
                    ‚¨áÔ∏è Load from Sheets
                </button>
                <button id="toggleSyncBtn" onclick="toggleSync()" class="btn" style="min-width: 150px; background: var(--wheat-gold); color: white;">
                    üîÑ Auto-Sync: ON
                </button>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Active Goats</div>
                <div class="stat-value" id="stat-active">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Does</div>
                <div class="stat-value" id="stat-does">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Bucks</div>
                <div class="stat-value" id="stat-bucks">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Wethers</div>
                <div class="stat-value" id="stat-wethers">0</div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('registry')">Goat Registry</button>
            <button class="tab" onclick="showTab('familytree')">Family Tree</button>
            <button class="tab" onclick="showTab('kidding')">Kidding History</button>
            <button class="tab" onclick="showTab('treatments')">Treatment Records</button>
            <button class="tab" onclick="showTab('feed')">Feed Cost Tracking</button>
            <button class="tab" onclick="showTab('reports')">Reports</button>
        </div>
        
        <!-- REGISTRY TAB -->
        <div id="registry" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Goat Registry</h2>
                    <div class="card-header-buttons">
                        <button class="btn btn-secondary" onclick="exportGoatRegistry()">üìä Export to CSV</button>
                        <button class="btn btn-secondary" onclick="openBulkSaleModal()">üí∞ Bulk Sale</button>
                        <button class="btn btn-primary" onclick="openAddGoatModal()">+ Add New Goat</button>
                    </div>
                </div>
                
                <div class="search-filters">
                    <input type="text" id="searchInput" placeholder="Search by name, tag, color..." onkeyup="filterGoats()">
                    <select id="genderFilter" onchange="filterGoats()">
                        <option value="">All Genders</option>
                        <option value="Doe">Does</option>
                        <option value="Buck">Bucks</option>
                        <option value="Wether">Wethers</option>
                    </select>
                    <select id="statusFilter" onchange="filterGoats()">
                        <option value="">All Status</option>
                        <option value="Active">Active</option>
                        <option value="Sold">Sold</option>
                        <option value="Culled">Culled</option>
                        <option value="Deceased">Deceased</option>
                    </select>
                    <select id="yearFilter" onchange="filterGoats()">
                        <option value="">All Years</option>
                    </select>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Photo</th>
                            <th class="sortable" onclick="sortTable('name')">Name</th>
                            <th class="sortable" onclick="sortTable('tag')">Tag</th>
                            <th class="sortable" onclick="sortTable('status')">Status</th>
                            <th class="sortable" onclick="sortTable('gender')">Gender</th>
                            <th class="sortable" onclick="sortTable('birthDate')">Birth Date</th>
                            <th class="sortable" onclick="sortTable('color')">Color</th>
                            <th>Problems</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="goatTableBody"></tbody>
                </table>
            </div>
        </div>
        
        <!-- FAMILY TREE TAB -->
        <div id="familytree" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Family Tree View</h2>
                    <select id="treeViewFilter" onchange="renderFamilyTree()">
                        <option value="all">All Goats</option>
                        <option value="does">Does Only</option>
                        <option value="bucks">Bucks Only</option>
                    </select>
                </div>
                <div id="familyTreeContainer"></div>
            </div>
        </div>
        
        <!-- KIDDING HISTORY TAB -->
        <div id="kidding" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Kidding History & Analytics</h2>
                    <button class="btn btn-primary" onclick="openAddKiddingModal()">+ Add Kidding Record</button>
                </div>
                
                <div class="stats" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-label">Total Kiddings</div>
                        <div class="stat-value" id="kidding-total">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Litter Size</div>
                        <div class="stat-value" id="kidding-avg">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Singles Rate</div>
                        <div class="stat-value" id="kidding-singles">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Twins Rate</div>
                        <div class="stat-value" id="kidding-twins">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Triplets+ Rate</div>
                        <div class="stat-value" id="kidding-triplets">0%</div>
                    </div>
                </div>
                
                <div class="search-filters">
                    <select id="kiddingDoeFilter" onchange="displayKiddingRecords()">
                        <option value="">All Does</option>
                    </select>
                    <select id="kiddingYearFilter" onchange="displayKiddingRecords()">
                        <option value="">All Years</option>
                    </select>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Doe</th>
                            <th>Sire</th>
                            <th>Year</th>
                            <th>Litter Size</th>
                            <th>Bucks</th>
                            <th>Does</th>
                            <th>Ease</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="kiddingTableBody"></tbody>
                </table>
                
                <h3 class="section-title" style="margin-top: 40px;">Doe Performance Summary</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Doe Name</th>
                            <th>Total Kiddings</th>
                            <th>Avg Litter Size</th>
                            <th>Singles</th>
                            <th>Twins</th>
                            <th>Triplets+</th>
                            <th>Avg Ease</th>
                        </tr>
                    </thead>
                    <tbody id="doePerformanceBody"></tbody>
                </table>
            </div>
        </div>
        
        <!-- TREATMENTS TAB -->
        <div id="treatments" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Treatment Records</h2>
                    <button class="btn btn-primary" onclick="openAddTreatmentModal()">+ Add Treatment</button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Tag(s)</th>
                            <th>Type</th>
                            <th>Medication</th>
                            <th>Dosage</th>
                            <th>Route</th>
                            <th>Withdrawal</th>
                            <th>Cost</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="treatmentTableBody"></tbody>
                </table>
            </div>
        </div>
        
        <!-- FEED TAB -->
        <div id="feed" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Feed Cost Tracking</h2>
                    <button class="btn btn-primary" onclick="openAddFeedModal()">+ Add Feed Purchase</button>
                </div>
                
                <div class="stats" style="margin-bottom: 25px;">
                    <div class="stat-card">
                        <div class="stat-label">Total Feed Cost</div>
                        <div class="stat-value" id="feed-total">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Cost Per Goat</div>
                        <div class="stat-value" id="feed-per-goat">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">This Month</div>
                        <div class="stat-value" id="feed-month">$0</div>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Feed Type</th>
                            <th>Quantity</th>
                            <th>Cost</th>
                            <th>Supplier</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="feedTableBody"></tbody>
                </table>
            </div>
        </div>
        
        <!-- REPORTS TAB -->
        <div id="reports" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Comprehensive Reports & Analytics</h2>
                    <button class="btn btn-primary" onclick="exportReport()">üìä Export to CSV</button>
                </div>
                
                <h3 class="section-title">Financial Summary</h3>
                <div class="stats" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-label">Total Sales Revenue</div>
                        <div class="stat-value" id="report-sales">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Feed Costs</div>
                        <div class="stat-value" id="report-feed">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Treatment Costs</div>
                        <div class="stat-value" id="report-treatment">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Net Profit/Loss</div>
                        <div class="stat-value" id="report-net">$0</div>
                    </div>
                </div>
                
                <h3 class="section-title">Herd Analytics</h3>
                <div class="stats" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-label">Average Sale Price</div>
                        <div class="stat-value" id="report-avg-sale">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Animals Ever</div>
                        <div class="stat-value" id="report-total-ever">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Retention Rate</div>
                        <div class="stat-value" id="report-retention">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Cull Rate</div>
                        <div class="stat-value" id="report-cull-rate">0%</div>
                    </div>
                </div>
                
                <h3 class="section-title">Cost Per Animal Analysis</h3>
                <div class="stats" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-label">Feed Cost Per Active Goat</div>
                        <div class="stat-value" id="report-feed-per-goat">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Treatment Cost Per Active Goat</div>
                        <div class="stat-value" id="report-treatment-per-goat">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Cost Per Active Goat</div>
                        <div class="stat-value" id="report-total-per-goat">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Monthly Feed Cost</div>
                        <div class="stat-value" id="report-monthly-feed">$0</div>
                    </div>
                </div>
                
                <h3 class="section-title">Herd Composition</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #f9f7f3; padding: 20px; border-radius: 12px;">
                        <h4 style="margin-bottom: 15px; color: var(--barn-red);">By Gender</h4>
                        <div id="gender-breakdown"></div>
                    </div>
                    <div style="background: #f9f7f3; padding: 20px; border-radius: 12px;">
                        <h4 style="margin-bottom: 15px; color: var(--barn-red);">By Age Group</h4>
                        <div id="age-breakdown"></div>
                    </div>
                    <div style="background: #f9f7f3; padding: 20px; border-radius: 12px;">
                        <h4 style="margin-bottom: 15px; color: var(--barn-red);">Health Issues</h4>
                        <div id="health-breakdown"></div>
                    </div>
                </div>
                
                <h3 class="section-title">Breeding Performance</h3>
                <table style="margin-bottom: 40px;">
                    <thead>
                        <tr>
                            <th>Mother (Dam)</th>
                            <th>Number of Kids</th>
                            <th>Avg Kidding Ease</th>
                            <th>Active Kids</th>
                            <th>Sold Kids</th>
                        </tr>
                    </thead>
                    <tbody id="breedingTableBody"></tbody>
                </table>
                
                <h3 class="section-title">Sales Summary</h3>
                <div style="background: #f9f7f3; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <div style="font-size: 0.9rem; color: var(--field-green); font-weight: 600;">Total Sold</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="sales-total-count">0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: var(--field-green); font-weight: 600;">Bucks Sold</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="sales-bucks">0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: var(--field-green); font-weight: 600;">Does Sold</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="sales-does">0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: var(--field-green); font-weight: 600;">Avg Age at Sale</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="sales-avg-age">0</div>
                        </div>
                    </div>
                </div>
                <table style="margin-bottom: 40px;">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Tag</th>
                            <th>Gender</th>
                            <th>Birth Date</th>
                            <th>Sale Price</th>
                            <th>Age at Sale</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody"></tbody>
                </table>
                
                <h3 class="section-title">Treatment Analysis</h3>
                <div style="background: #f9f7f3; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <div style="font-size: 0.9rem; color: var(--field-green); font-weight: 600;">Total Treatments</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="treatment-count">0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: var(--field-green); font-weight: 600;">Most Common Type</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="treatment-common">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: var(--field-green); font-weight: 600;">Avg Cost Per Treatment</div>
                            <div style="font-size: 1.5rem; font-weight: 700;" id="treatment-avg-cost">$0</div>
                        </div>
                    </div>
                </div>
                
                <h3 class="section-title">Culled Animals</h3>
                <table style="margin-bottom: 40px;">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Tag</th>
                            <th>Gender</th>
                            <th>Cull Date</th>
                            <th>Reason</th>
                            <th>Age at Cull</th>
                        </tr>
                    </thead>
                    <tbody id="culledTableBody"></tbody>
                </table>
                
                <h3 class="section-title">Annual Cost Breakdown</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>Feed Costs</th>
                            <th>Treatment Costs</th>
                            <th>Total Costs</th>
                            <th>Sales Revenue</th>
                            <th>Net Profit/Loss</th>
                        </tr>
                    </thead>
                    <tbody id="yearCostsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- MODALS -->
    
    <!-- Add Goat Modal -->
    <div id="addGoatModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('addGoatModal')">&times;</button>
            <h2 class="modal-title">Add New Goat</h2>
            <form onsubmit="return addGoat(event)">
                <div class="photo-upload-container">
                    <label class="form-group">
                        <strong>Photo</strong>
                        <div class="photo-upload-btn">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('addPhotoInput').click()">üì∑ Choose Photo</button>
                            <input type="file" id="addPhotoInput" accept="image/*" onchange="previewPhoto(this, 'addPhotoPreview')">
                        </div>
                    </label>
                    <img id="addPhotoPreview" class="photo-preview" style="display: none;">
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="name">
                    </div>
                    <div class="form-group">
                        <label>Tag Number *</label>
                        <input type="text" id="tag" required>
                    </div>
                    <div class="form-group">
                        <label>Gender</label>
                        <select id="gender">
                            <option value="Doe">Doe</option>
                            <option value="Buck">Buck</option>
                            <option value="Wether">Wether</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Birth Date</label>
                        <input type="date" id="birthDate">
                    </div>
                    <div class="form-group">
                        <label>Father (Sire)</label>
                        <input type="text" id="sire">
                    </div>
                    <div class="form-group">
                        <label>Mother (Dam)</label>
                        <input type="text" id="dam">
                    </div>
                    <div class="form-group">
                        <label>Color</label>
                        <input type="text" id="color">
                    </div>
                    <div class="form-group">
                        <label>Weaned Date</label>
                        <input type="date" id="weanedDate">
                    </div>
                    <div class="form-group">
                        <label>Kidding Ease (1-5)</label>
                        <select id="kiddingEase">
                            <option value="">N/A</option>
                            <option value="1">1 - Very Easy</option>
                            <option value="2">2 - Easy</option>
                            <option value="3">3 - Moderate</option>
                            <option value="4">4 - Difficult</option>
                            <option value="5">5 - Very Difficult</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>Health Problems</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="badFeet">
                            <label for="badFeet" style="margin: 0;">Bad Feet</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="poorUdder">
                            <label for="poorUdder" style="margin: 0;">Poor Udder</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="kidsPoorly">
                            <label for="kidsPoorly" style="margin: 0;">Kids Poorly</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="digestive">
                            <label for="digestive" style="margin: 0;">Digestive Issues</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="notes"></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">Add Goat</button>
            </form>
        </div>
    </div>
    
    <!-- Edit Goat Modal -->
    <div id="editGoatModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('editGoatModal')">&times;</button>
            <h2 class="modal-title">Edit Goat</h2>
            <form onsubmit="updateGoat(event)">
                <input type="hidden" id="editId">
                
                <div class="photo-upload-container">
                    <label class="form-group">
                        <strong>Photo</strong>
                        <div class="photo-upload-btn">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('editPhotoInput').click()">üì∑ Change Photo</button>
                            <input type="file" id="editPhotoInput" accept="image/*" onchange="previewPhoto(this, 'editPhotoPreview')">
                        </div>
                    </label>
                    <img id="editPhotoPreview" class="photo-preview" style="display: none;">
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="editName">
                    </div>
                    <div class="form-group">
                        <label>Tag Number *</label>
                        <input type="text" id="editTag" required>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="editStatus">
                            <option value="Active">Active</option>
                            <option value="Sold">Sold</option>
                            <option value="Culled">Culled</option>
                            <option value="Deceased">Deceased</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Gender</label>
                        <select id="editGender">
                            <option value="Doe">Doe</option>
                            <option value="Buck">Buck</option>
                            <option value="Wether">Wether</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Birth Date</label>
                        <input type="date" id="editBirthDate">
                    </div>
                    <div class="form-group">
                        <label>Father (Sire)</label>
                        <input type="text" id="editSire">
                    </div>
                    <div class="form-group">
                        <label>Mother (Dam)</label>
                        <input type="text" id="editDam">
                    </div>
                    <div class="form-group">
                        <label>Color</label>
                        <input type="text" id="editColor">
                    </div>
                    <div class="form-group">
                        <label>Weaned Date</label>
                        <input type="date" id="editWeanedDate">
                    </div>
                    <div class="form-group">
                        <label>Kidding Ease</label>
                        <select id="editKiddingEase">
                            <option value="">N/A</option>
                            <option value="1">1 - Very Easy</option>
                            <option value="2">2 - Easy</option>
                            <option value="3">3 - Moderate</option>
                            <option value="4">4 - Difficult</option>
                            <option value="5">5 - Very Difficult</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sale Price</label>
                        <input type="number" id="editSalePrice" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Cull Date</label>
                        <input type="date" id="editCullDate">
                    </div>
                    <div class="form-group">
                        <label>Cull Reason</label>
                        <input type="text" id="editCullReason">
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>Health Problems</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="editBadFeet">
                            <label for="editBadFeet" style="margin: 0;">Bad Feet</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="editPoorUdder">
                            <label for="editPoorUdder" style="margin: 0;">Poor Udder</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="editKidsPoorly">
                            <label for="editKidsPoorly" style="margin: 0;">Kids Poorly</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="editDigestive">
                            <label for="editDigestive" style="margin: 0;">Digestive Issues</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="editNotes"></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary">Update Goat</button>
            </form>
        </div>
    </div>
    
    <!-- View Goat Modal -->
    <div id="viewGoatModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('viewGoatModal')">&times;</button>
            <h2 class="modal-title" id="viewGoatTitle"></h2>
            <div id="viewGoatContent"></div>
            <div style="margin-top: 30px; display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="editFromView()">Edit Goat</button>
                <button class="btn btn-primary" onclick="closeModal('viewGoatModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Add Weight Modal -->
    <div id="addWeightModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('addWeightModal')">&times;</button>
            <h2 class="modal-title">Add Weight Record</h2>
            <form onsubmit="addWeight(event)">
                <input type="hidden" id="weightGoatId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="weightDate" required>
                    </div>
                    <div class="form-group">
                        <label>Weight (lbs) *</label>
                        <input type="number" id="weightValue" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label>Body Condition (1-5)</label>
                        <select id="bodyCondition">
                            <option value="">N/A</option>
                            <option value="1">1 - Emaciated</option>
                            <option value="2">2 - Thin</option>
                            <option value="3">3 - Ideal</option>
                            <option value="4">4 - Fat</option>
                            <option value="5">5 - Obese</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="weightNotes"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Weight</button>
            </form>
        </div>
    </div>
    
    <!-- Add Treatment Modal -->
    <div id="addTreatmentModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('addTreatmentModal')">&times;</button>
            <h2 class="modal-title">Record Treatment</h2>
            
            <div class="info-box">
                <h3 style="margin-bottom: 10px; font-size: 1.1rem;">üí° Bulk Treatment Options</h3>
                <p><strong>To treat multiple goats at once:</strong></p>
                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                    <li><strong>ALL ACTIVE</strong> - treats all active goats</li>
                    <li><strong>ALL DOES</strong> - treats all active does</li>
                    <li><strong>ALL BUCKS</strong> - treats all active bucks</li>
                    <li><strong>ALL WETHERS</strong> - treats all active wethers</li>
                    <li><strong>G001, G002, G003</strong> - treats specific goats (comma-separated)</li>
                </ul>
            </div>
            
            <form onsubmit="addTreatment(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="treatmentDate" required>
                    </div>
                    <div class="form-group">
                        <label>Tag Number(s) *</label>
                        <input type="text" id="treatmentTags" placeholder="G001, ALL DOES, etc." required>
                    </div>
                    <div class="form-group">
                        <label>Treatment Type *</label>
                        <select id="treatmentType" required>
                            <option value="">-- Select --</option>
                            <option value="Vaccination">Vaccination</option>
                            <option value="Deworming">Deworming</option>
                            <option value="Antibiotic">Antibiotic</option>
                            <option value="Hoof Care">Hoof Care</option>
                            <option value="Surgery">Surgery</option>
                            <option value="Wound Care">Wound Care</option>
                            <option value="Parasite Control">Parasite Control</option>
                            <option value="Vitamin/Supplement">Vitamin/Supplement</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Medication *</label>
                        <input type="text" id="medication" required>
                    </div>
                    <div class="form-group">
                        <label>Dosage</label>
                        <input type="text" id="dosage">
                    </div>
                    <div class="form-group">
                        <label>Route</label>
                        <select id="route">
                            <option value="">-- Select --</option>
                            <option value="Oral">Oral</option>
                            <option value="Injectable - SQ">Injectable - SQ</option>
                            <option value="Injectable - IM">Injectable - IM</option>
                            <option value="Injectable - IV">Injectable - IV</option>
                            <option value="Topical">Topical</option>
                            <option value="Pour-On">Pour-On</option>
                            <option value="Drench">Drench</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Withdrawal (Meat)</label>
                        <input type="date" id="withdrawalMeat">
                    </div>
                    <div class="form-group">
                        <label>Withdrawal (Milk)</label>
                        <input type="date" id="withdrawalMilk">
                    </div>
                    <div class="form-group">
                        <label>Veterinarian</label>
                        <input type="text" id="vet">
                    </div>
                    <div class="form-group">
                        <label>Cost</label>
                        <input type="number" id="treatmentCost" step="0.01">
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="treatmentNotes"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Record Treatment</button>
            </form>
        </div>
    </div>
    
    <!-- Edit Treatment Modal -->
    <div id="editTreatmentModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('editTreatmentModal')">&times;</button>
            <h2 class="modal-title">Edit Treatment</h2>
            <form onsubmit="updateTreatment(event)">
                <input type="hidden" id="editTreatmentId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="editTreatmentDate" required>
                    </div>
                    <div class="form-group">
                        <label>Tag Number(s) *</label>
                        <input type="text" id="editTreatmentTags" required>
                    </div>
                    <div class="form-group">
                        <label>Treatment Type *</label>
                        <select id="editTreatmentType" required>
                            <option value="">-- Select --</option>
                            <option value="Vaccination">Vaccination</option>
                            <option value="Deworming">Deworming</option>
                            <option value="Antibiotic">Antibiotic</option>
                            <option value="Hoof Care">Hoof Care</option>
                            <option value="Surgery">Surgery</option>
                            <option value="Wound Care">Wound Care</option>
                            <option value="Parasite Control">Parasite Control</option>
                            <option value="Vitamin/Supplement">Vitamin/Supplement</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Medication *</label>
                        <input type="text" id="editMedication" required>
                    </div>
                    <div class="form-group">
                        <label>Dosage</label>
                        <input type="text" id="editDosage">
                    </div>
                    <div class="form-group">
                        <label>Route</label>
                        <select id="editRoute">
                            <option value="">-- Select --</option>
                            <option value="Oral">Oral</option>
                            <option value="Injectable - SQ">Injectable - SQ</option>
                            <option value="Injectable - IM">Injectable - IM</option>
                            <option value="Injectable - IV">Injectable - IV</option>
                            <option value="Topical">Topical</option>
                            <option value="Pour-On">Pour-On</option>
                            <option value="Drench">Drench</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Withdrawal (Meat)</label>
                        <input type="date" id="editWithdrawalMeat">
                    </div>
                    <div class="form-group">
                        <label>Withdrawal (Milk)</label>
                        <input type="date" id="editWithdrawalMilk">
                    </div>
                    <div class="form-group">
                        <label>Veterinarian</label>
                        <input type="text" id="editVet">
                    </div>
                    <div class="form-group">
                        <label>Cost</label>
                        <input type="number" id="editTreatmentCost" step="0.01">
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="editTreatmentNotes"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Update Treatment</button>
            </form>
        </div>
    </div>
    
    <!-- Add Feed Modal -->
    <div id="addFeedModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('addFeedModal')">&times;</button>
            <h2 class="modal-title">Add Feed Purchase</h2>
            <form onsubmit="addFeed(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="feedDate" required>
                    </div>
                    <div class="form-group">
                        <label>Feed Type *</label>
                        <input type="text" id="feedType" required>
                    </div>
                    <div class="form-group">
                        <label>Quantity *</label>
                        <input type="text" id="feedQuantity" required>
                    </div>
                    <div class="form-group">
                        <label>Cost *</label>
                        <input type="number" id="feedCost" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <input type="text" id="feedSupplier">
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="feedNotes"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Feed Purchase</button>
            </form>
        </div>
    </div>
    
    <!-- Bulk Sale Modal -->
    <div id="bulkSaleModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('bulkSaleModal')">&times;</button>
            <h2 class="modal-title">Bulk Sale</h2>
            
            <div class="info-box">
                <h3 style="margin-bottom: 10px;">üìù How it works</h3>
                <p>Select the goats you sold, enter the total sale amount, and we'll divide it equally among them.</p>
            </div>
            
            <form onsubmit="processBulkSale(event)">
                <div class="form-group" style="margin-bottom: 25px;">
                    <label>Total Sale Amount *</label>
                    <input type="number" id="bulkSaleTotal" step="0.01" min="0" required placeholder="e.g., 4000" onchange="updateBulkSaleCalculation()" onkeyup="updateBulkSaleCalculation()">
                </div>
                
                <div class="form-group" style="margin-bottom: 25px;">
                    <label>Sale Date *</label>
                    <input type="date" id="bulkSaleDate" required>
                </div>
                
                <div class="form-group" style="margin-bottom: 25px;">
                    <label>Buyer/Notes</label>
                    <textarea id="bulkSaleNotes" placeholder="Optional: Buyer name, details, etc."></textarea>
                </div>
                
                <div class="form-group">
                    <label style="margin-bottom: 15px; font-size: 1.1rem;">Select Goats to Sell (Active Goats Only)</label>
                    <div style="max-height: 400px; overflow-y: auto; border: 2px solid var(--light-tan); border-radius: 8px; padding: 15px;">
                        <div id="bulkSaleGoatList"></div>
                    </div>
                </div>
                
                <div style="background: #f9f7f3; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <strong>Selected:</strong> <span id="bulkSaleCount">0</span> goats | 
                    <strong>Price per goat:</strong> $<span id="bulkSalePerGoat">0.00</span>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">Complete Bulk Sale</button>
            </form>
        </div>
    </div>
    
    <!-- Add Kidding Modal -->
    <div id="addKiddingModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('addKiddingModal')">&times;</button>
            <h2 class="modal-title">Add Kidding Record</h2>
            <form onsubmit="addKidding(event)">
                <div class="form-group">
                    <label>Kidding Date *</label>
                    <input type="date" id="kiddingDate" required>
                </div>
                
                <div class="form-group">
                    <label>Doe Name *</label>
                    <select id="kiddingDoe" required>
                        <option value="">Select Doe</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Sire (Father)</label>
                    <select id="kiddingSire">
                        <option value="">Unknown/Select Sire</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Number of Bucks Born</label>
                    <input type="number" id="kiddingBucks" value="0" min="0" onchange="updateLitterSize()">
                </div>
                
                <div class="form-group">
                    <label>Number of Does Born</label>
                    <input type="number" id="kiddingDoes" value="0" min="0" onchange="updateLitterSize()">
                </div>
                
                <div class="form-group">
                    <label>Total Litter Size</label>
                    <input type="number" id="kiddingLitterSize" readonly style="background: #f5f5f5;">
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="kiddingAutoAdd" checked style="width: 20px; height: 20px;" onchange="toggleKidTagInputs()">
                        <span>Automatically add kids to Goat Registry</span>
                    </label>
                </div>
                
                <div id="kiddingTagInputs" style="display: none;">
                    <div class="form-group">
                        <label><strong>Kid Details (Tag, Color, Birth Weight)</strong></label>
                        <small style="color: #666; display: block; margin-bottom: 10px;">Enter information for each kid. Only tag number is required.</small>
                        <div id="kidTagFields"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Kidding Ease (1-5) *</label>
                    <select id="kiddingEaseInput" required>
                        <option value="1">1 - Very Easy</option>
                        <option value="2">2 - Easy</option>
                        <option value="3">3 - Moderate</option>
                        <option value="4">4 - Difficult</option>
                        <option value="5">5 - Very Difficult</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="kiddingNotes" rows="3" placeholder="Any complications, health issues, etc."></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">Add Kidding Record</button>
            </form>
        </div>
    </div>
            renderFamilyTree();
            populateYearFilter();
            closeModal('addGoatModal');
            e.target.reset();
            return false;
        }
        
        function displayGoats() {
            const tbody = document.getElementById('goatTableBody');
            tbody.innerHTML = '';
            
            const search = (document.getElementById('searchInput')?.value || '').toLowerCase();
            const genderFilter = document.getElementById('genderFilter')?.value || '';
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            const yearFilter = document.getElementById('yearFilter')?.value || '';
            
            let filtered = goats.filter(g => {
                const matchSearch = (g.name || '').toLowerCase().includes(search) || 
                                   (g.tag || '').toLowerCase().includes(search) ||
                                   (g.color || '').toLowerCase().includes(search);
                const matchGender = !genderFilter || g.gender === genderFilter;
                const matchStatus = !statusFilter || g.status === statusFilter;
                const matchYear = !yearFilter || (g.birthDate && new Date(g.birthDate).getFullYear().toString() === yearFilter);
                return matchSearch && matchGender && matchStatus && matchYear;
            });
            
            if (!currentSortColumn) {
                filtered.sort((a, b) => (a.name || a.tag || '').localeCompare(b.name || b.tag || ''));
            } else {
                filtered = applySortToArray(filtered);
            }
            
            filtered.forEach(g => {
                const problems = [];
                if (g.badFeet) problems.push('Bad Feet');
                if (g.poorUdder) problems.push('Poor Udder');
                if (g.kidsPoorly) problems.push('Kids Poorly');
                if (g.digestive) problems.push('Digestive');
                
                const row = tbody.insertRow();
                row.innerHTML = 
                    '<td>' + (g.photo ? '<img src="' + g.photo + '" class="goat-photo-small">' : 'üì∑') + '</td>' +
                    '<td><strong>' + (g.name || g.tag) + '</strong></td>' +
                    '<td>' + (g.tag || '') + '</td>' +
                    '<td><span class="badge badge-' + (g.status || 'active').toLowerCase() + '">' + (g.status || 'Active') + '</span></td>' +
                    '<td>' + (g.gender || '') + '</td>' +
                    '<td>' + (g.birthDate ? new Date(g.birthDate).toLocaleDateString() : 'N/A') + '</td>' +
                    '<td>' + (g.color || '-') + '</td>' +
                    '<td>' + (problems.join(', ') || 'None') + '</td>' +
                    '<td><div class="action-btns">' +
                    '<button class="btn btn-primary btn-small" onclick="viewGoatDetails(' + g.id + ')">View</button>' +
                    '<button class="btn btn-secondary btn-small" onclick="editGoat(' + g.id + ')">Edit</button>' +
                    '<button class="btn btn-danger btn-small" onclick="deleteGoat(' + g.id + ')">Delete</button>' +
                    '</div></td>';
            });
        }
        
        function filterGoats() { displayGoats(); }
        
        function applySortToArray(array) {
            if (!currentSortColumn) return array;
            
            return array.sort((a, b) => {
                let aVal, bVal;
                
                switch(currentSortColumn) {
                    case 'name': aVal = (a.name || a.tag || '').toLowerCase(); bVal = (b.name || b.tag || '').toLowerCase(); break;
                    case 'tag': aVal = (a.tag || '').toLowerCase(); bVal = (b.tag || '').toLowerCase(); break;
                    case 'status': aVal = (a.status || '').toLowerCase(); bVal = (b.status || '').toLowerCase(); break;
                    case 'gender': aVal = (a.gender || '').toLowerCase(); bVal = (b.gender || '').toLowerCase(); break;
                    case 'birthDate': aVal = a.birthDate ? new Date(a.birthDate) : new Date(0); bVal = b.birthDate ? new Date(b.birthDate) : new Date(0); break;
                    case 'color': aVal = (a.color || '').toLowerCase(); bVal = (b.color || '').toLowerCase(); break;
                    default: return 0;
                }
                
                if (currentSortColumn === 'birthDate') {
                    return currentSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                }
                
                if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        function sortTable(column) {
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }
            
            document.querySelectorAll('th.sortable').forEach(th => th.classList.remove('asc', 'desc'));
            
            const headerMap = { 'name': 1, 'tag': 2, 'status': 3, 'gender': 4, 'birthDate': 5, 'color': 6 };
            const headers = document.querySelectorAll('th.sortable');
            if (headers[headerMap[column] - 1]) {
                headers[headerMap[column] - 1].classList.add(currentSortDirection);
            }
            
            goats = applySortToArray(goats);
            displayGoats();
        }
        
        function editGoat(id) {
            const goat = goats.find(g => g.id === id);
            if (!goat) return;
            
            document.getElementById('editId').value = goat.id;
            document.getElementById('editName').value = goat.name || '';
            document.getElementById('editTag').value = goat.tag || '';
            document.getElementById('editStatus').value = goat.status || 'Active';
            document.getElementById('editGender').value = goat.gender || 'Doe';
            document.getElementById('editBirthDate').value = goat.birthDate || '';
            document.getElementById('editSire').value = goat.sire || '';
            document.getElementById('editDam').value = goat.dam || '';
            document.getElementById('editColor').value = goat.color || '';
            document.getElementById('editWeanedDate').value = goat.weanedDate || '';
            document.getElementById('editKiddingEase').value = goat.kiddingEase || '';
            document.getElementById('editSalePrice').value = goat.salePrice || '';
            document.getElementById('editCullDate').value = goat.cullDate || '';
            document.getElementById('editCullReason').value = goat.cullReason || '';
            document.getElementById('editBadFeet').checked = goat.badFeet || false;
            document.getElementById('editPoorUdder').checked = goat.poorUdder || false;
            document.getElementById('editKidsPoorly').checked = goat.kidsPoorly || false;
            document.getElementById('editDigestive').checked = goat.digestive || false;
            document.getElementById('editNotes').value = goat.notes || '';
            
            if (goat.photo) {
                const preview = document.getElementById('editPhotoPreview');
                preview.src = goat.photo;
                preview.style.display = 'block';
            }
            
            document.getElementById('editGoatModal').classList.add('active');
        }
        
        async function updateGoat(e) {
            e.preventDefault();
            const id = parseInt(document.getElementById('editId').value);
            const goat = goats.find(g => g.id === id);
            
            if (goat) {
                const photoInput = document.getElementById('editPhotoInput');
                if (photoInput.files && photoInput.files[0]) {
                    goat.photo = await getPhotoData('editPhotoInput');
                }
                
                goat.name = document.getElementById('editName').value;
                goat.tag = document.getElementById('editTag').value;
                goat.status = document.getElementById('editStatus').value;
                goat.gender = document.getElementById('editGender').value;
                goat.birthDate = document.getElementById('editBirthDate').value;
                goat.sire = document.getElementById('editSire').value;
                goat.dam = document.getElementById('editDam').value;
                goat.color = document.getElementById('editColor').value;
                goat.weanedDate = document.getElementById('editWeanedDate').value;
                goat.kiddingEase = document.getElementById('editKiddingEase').value;
                goat.salePrice = document.getElementById('editSalePrice').value;
                goat.cullDate = document.getElementById('editCullDate').value;
                goat.cullReason = document.getElementById('editCullReason').value;
                goat.badFeet = document.getElementById('editBadFeet').checked;
                goat.poorUdder = document.getElementById('editPoorUdder').checked;
                goat.kidsPoorly = document.getElementById('editKidsPoorly').checked;
                goat.digestive = document.getElementById('editDigestive').checked;
                goat.notes = document.getElementById('editNotes').value;
                
                localStorage.setItem('goats', JSON.stringify(goats));
                
                if (syncEnabled && AUTO_SYNC_ON_CHANGE) {
                    callAppsScript('updateGoat', goat);
                }
                
                displayGoats();
                updateStats();
                updateReports();
                renderFamilyTree();
                closeModal('editGoatModal');
            }
        }
        
        function deleteGoat(id) {
            if (!confirm('Delete this goat? This cannot be undone.')) return;
            
            goats = goats.filter(g => g.id !== id);
            localStorage.setItem('goats', JSON.stringify(goats));
            displayGoats();
            updateStats();
            updateReports();
            renderFamilyTree();
            populateYearFilter();
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // VIEW GOAT DETAILS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function calculateAge(birthDate) {
            if (!birthDate) return 'N/A';
            const birth = new Date(birthDate);
            const today = new Date();
            const months = (today.getFullYear() - birth.getFullYear()) * 12 + (today.getMonth() - birth.getMonth());
            
            if (months < 12) return months + ' months';
            const years = Math.floor(months / 12);
            const remainingMonths = months % 12;
            return remainingMonths > 0 ? years + 'y ' + remainingMonths + 'm' : years + ' years';
        }
        
        function viewGoatDetails(id) {
            const goat = goats.find(g => g.id === id);
            if (!goat) return;
            
            currentViewGoatId = id;
            document.getElementById('viewGoatTitle').textContent = goat.name || goat.tag;
            
            const problems = [];
            if (goat.badFeet) problems.push('Bad Feet');
            if (goat.poorUdder) problems.push('Poor Udder');
            if (goat.kidsPoorly) problems.push('Kids Poorly');
            if (goat.digestive) problems.push('Digestive Issues');
            
            const age = calculateAge(goat.birthDate);
            
            let html = '<div class="detail-section">';
            
            if (goat.photo) {
                html += '<img src="' + goat.photo + '" class="goat-photo-large">';
            }
            
            html += '<h3 class="section-title">Basic Information</h3>';
            html += '<div class="detail-grid">';
            html += '<div class="detail-item"><div class="detail-label">Tag Number</div><div class="detail-value">' + goat.tag + '</div></div>';
            html += '<div class="detail-item"><div class="detail-label">Status</div><div class="detail-value"><span class="badge badge-' + goat.status.toLowerCase() + '">' + goat.status + '</span></div></div>';
            html += '<div class="detail-item"><div class="detail-label">Gender</div><div class="detail-value">' + goat.gender + '</div></div>';
            html += '<div class="detail-item"><div class="detail-label">Birth Date</div><div class="detail-value">' + (goat.birthDate ? new Date(goat.birthDate).toLocaleDateString() : 'N/A') + '</div></div>';
            html += '<div class="detail-item"><div class="detail-label">Age</div><div class="detail-value">' + age + '</div></div>';
            html += '<div class="detail-item"><div class="detail-label">Color</div><div class="detail-value">' + (goat.color || 'N/A') + '</div></div>';
            html += '</div></div>';
            
            html += '<div class="detail-section">';
            html += '<h3 class="section-title">Parentage</h3>';
            html += '<div class="detail-grid">';
            html += '<div class="detail-item"><div class="detail-label">Father (Sire)</div><div class="detail-value">' + (goat.sire || 'Unknown') + '</div></div>';
            html += '<div class="detail-item"><div class="detail-label">Mother (Dam)</div><div class="detail-value">' + (goat.dam || 'Unknown') + '</div></div>';
            html += '</div></div>';
            
            html += '<div class="detail-section">';
            html += '<h3 class="section-title">Health</h3>';
            html += '<p style="font-size: 1.1rem;">' + (problems.length > 0 ? problems.join(', ') : 'No known health issues') + '</p>';
            html += '</div>';
            
            if (goat.status === 'Sold' && goat.salePrice) {
                html += '<div class="detail-section">';
                html += '<h3 class="section-title">Sale Details</h3>';
                html += '<div class="detail-grid">';
                html += '<div class="detail-item"><div class="detail-label">Sale Price</div><div class="detail-value">$' + goat.salePrice + '</div></div>';
                html += '</div></div>';
            }
            
            html += '<div class="detail-section">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">';
            html += '<h3 class="section-title" style="margin: 0;">Weight Records</h3>';
            html += '<button class="btn btn-secondary btn-small" onclick="openWeightModal(' + id + ')">+ Add Weight</button>';
            html += '</div>';
            
            if (goat.weights && goat.weights.length > 0) {
                html += '<div class="weight-records">';
                goat.weights.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(w => {
                    html += '<div class="weight-entry">';
                    html += '<div><strong>' + new Date(w.date).toLocaleDateString() + '</strong> - ' + w.weight + ' lbs';
                    if (w.bodyCondition) html += ' (BCS: ' + w.bodyCondition + ')';
                    if (w.notes) html += '<br><small style="color: #666;">' + w.notes + '</small>';
                    html += '</div>';
                    html += '<button class="btn btn-danger btn-small" onclick="deleteWeight(' + id + ', ' + w.id + ')">Delete</button>';
                    html += '</div>';
                });
                html += '</div>';
            } else {
                html += '<p style="color: #666;">No weight records yet.</p>';
            }
            html += '</div>';
            
            if (goat.notes) {
                html += '<div class="detail-section">';
                html += '<h3 class="section-title">Notes</h3>';
                html += '<p style="font-size: 1.1rem; line-height: 1.6;">' + goat.notes + '</p>';
                html += '</div>';
            }
            
            document.getElementById('viewGoatContent').innerHTML = html;
            document.getElementById('viewGoatModal').classList.add('active');
        }
        
        function editFromView() {
            if (currentViewGoatId) {
                closeModal('viewGoatModal');
                editGoat(currentViewGoatId);
            }
        }
        
        function openWeightModal(goatId) {
            document.getElementById('weightGoatId').value = goatId;
            document.getElementById('weightDate').value = new Date().toISOString().split('T')[0];
            closeModal('viewGoatModal');
            document.getElementById('addWeightModal').classList.add('active');
        }
        
        function addWeight(e) {
            e.preventDefault();
            const goatId = parseInt(document.getElementById('weightGoatId').value);
            const goat = goats.find(g => g.id === goatId);
            
            if (goat) {
                if (!goat.weights) goat.weights = [];
                goat.weights.push({
                    id: Date.now(),
                    date: document.getElementById('weightDate').value,
                    weight: document.getElementById('weightValue').value,
                    bodyCondition: document.getElementById('bodyCondition').value,
                    notes: document.getElementById('weightNotes').value
                });
                
                localStorage.setItem('goats', JSON.stringify(goats));
                closeModal('addWeightModal');
                e.target.reset();
                viewGoatDetails(goatId);
            }
        }
        
        function deleteWeight(goatId, weightId) {
            if (!confirm('Delete this weight record?')) return;
            
            const goat = goats.find(g => g.id === goatId);
            if (goat && goat.weights) {
                goat.weights = goat.weights.filter(w => w.id !== weightId);
                localStorage.setItem('goats', JSON.stringify(goats));
                viewGoatDetails(goatId);
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TREATMENT FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function addTreatment(e) {
            e.preventDefault();
            
            let tags = document.getElementById('treatmentTags').value.trim().toUpperCase();
            
            if (tags === 'ALL ACTIVE') {
                tags = goats.filter(g => g.status === 'Active').map(g => g.tag).join(', ');
            } else if (tags === 'ALL DOES') {
                tags = goats.filter(g => g.status === 'Active' && g.gender === 'Doe').map(g => g.tag).join(', ');
            } else if (tags === 'ALL BUCKS') {
                tags = goats.filter(g => g.status === 'Active' && g.gender === 'Buck').map(g => g.tag).join(', ');
            } else if (tags === 'ALL WETHERS') {
                tags = goats.filter(g => g.status === 'Active' && g.gender === 'Wether').map(g => g.tag).join(', ');
            }
            
            const treatment = {
                id: Date.now(),
                date: document.getElementById('treatmentDate').value,
                tags: tags,
                type: document.getElementById('treatmentType').value,
                medication: document.getElementById('medication').value,
                dosage: document.getElementById('dosage').value,
                route: document.getElementById('route').value,
                withdrawalMeat: document.getElementById('withdrawalMeat').value,
                withdrawalMilk: document.getElementById('withdrawalMilk').value,
                vet: document.getElementById('vet').value,
                cost: document.getElementById('treatmentCost').value,
                notes: document.getElementById('treatmentNotes').value
            };
            
            treatments.push(treatment);
            localStorage.setItem('treatments', JSON.stringify(treatments));
            
            if (syncEnabled && AUTO_SYNC_ON_CHANGE) {
                callAppsScript('addTreatment', treatment);
            }
            
            displayTreatments();
            updateReports();
            closeModal('addTreatmentModal');
            e.target.reset();
            document.getElementById('treatmentDate').value = new Date().toISOString().split('T')[0];
        }
        
        function displayTreatments() {
            const tbody = document.getElementById('treatmentTableBody');
            tbody.innerHTML = '';
            
            treatments.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(t => {
                const withdrawal = [];
                if (t.withdrawalMeat) withdrawal.push('Meat: ' + new Date(t.withdrawalMeat).toLocaleDateString());
                if (t.withdrawalMilk) withdrawal.push('Milk: ' + new Date(t.withdrawalMilk).toLocaleDateString());
                
                const row = tbody.insertRow();
                row.innerHTML = 
                    '<td>' + new Date(t.date).toLocaleDateString() + '</td>' +
                    '<td><strong>' + t.tags + '</strong></td>' +
                    '<td>' + t.type + '</td>' +
                    '<td>' + t.medication + '</td>' +
                    '<td>' + (t.dosage || '-') + '</td>' +
                    '<td>' + (t.route || '-') + '</td>' +
                    '<td>' + (withdrawal.join('<br>') || 'None') + '</td>' +
                    '<td>$' + (t.cost || '0') + '</td>' +
                    '<td><div class="action-btns">' +
                    '<button class="btn btn-secondary btn-small" onclick="editTreatment(' + t.id + ')">Edit</button>' +
                    '<button class="btn btn-danger btn-small" onclick="deleteTreatment(' + t.id + ')">Delete</button>' +
                    '</div></td>';
            });
        }
        
        function editTreatment(id) {
            const treatment = treatments.find(t => t.id === id);
            if (!treatment) return;
            
            document.getElementById('editTreatmentId').value = treatment.id;
            document.getElementById('editTreatmentDate').value = treatment.date;
            document.getElementById('editTreatmentTags').value = treatment.tags;
            document.getElementById('editTreatmentType').value = treatment.type;
            document.getElementById('editMedication').value = treatment.medication;
            document.getElementById('editDosage').value = treatment.dosage || '';
            document.getElementById('editRoute').value = treatment.route || '';
            document.getElementById('editWithdrawalMeat').value = treatment.withdrawalMeat || '';
            document.getElementById('editWithdrawalMilk').value = treatment.withdrawalMilk || '';
            document.getElementById('editVet').value = treatment.vet || '';
            document.getElementById('editTreatmentCost').value = treatment.cost || '';
            document.getElementById('editTreatmentNotes').value = treatment.notes || '';
            
            document.getElementById('editTreatmentModal').classList.add('active');
        }
        
        function updateTreatment(e) {
            e.preventDefault();
            
            const id = parseInt(document.getElementById('editTreatmentId').value);
            const index = treatments.findIndex(t => t.id === id);
            if (index === -1) return;
            
            let tags = document.getElementById('editTreatmentTags').value.trim().toUpperCase();
            
            if (tags === 'ALL ACTIVE') tags = goats.filter(g => g.status === 'Active').map(g => g.tag).join(', ');
            else if (tags === 'ALL DOES') tags = goats.filter(g => g.status === 'Active' && g.gender === 'Doe').map(g => g.tag).join(', ');
            else if (tags === 'ALL BUCKS') tags = goats.filter(g => g.status === 'Active' && g.gender === 'Buck').map(g => g.tag).join(', ');
            else if (tags === 'ALL WETHERS') tags = goats.filter(g => g.status === 'Active' && g.gender === 'Wether').map(g => g.tag).join(', ');
            
            treatments[index] = {
                id: id,
                date: document.getElementById('editTreatmentDate').value,
                tags: tags,
                type: document.getElementById('editTreatmentType').value,
                medication: document.getElementById('editMedication').value,
                dosage: document.getElementById('editDosage').value,
                route: document.getElementById('editRoute').value,
                withdrawalMeat: document.getElementById('editWithdrawalMeat').value,
                withdrawalMilk: document.getElementById('editWithdrawalMilk').value,
                vet: document.getElementById('editVet').value,
                cost: parseFloat(document.getElementById('editTreatmentCost').value) || 0,
                notes: document.getElementById('editTreatmentNotes').value
            };
            
            localStorage.setItem('treatments', JSON.stringify(treatments));
            displayTreatments();
            updateReports();
            closeModal('editTreatmentModal');
        }
        
        function deleteTreatment(id) {
            if (!confirm('Delete this treatment record?')) return;
            treatments = treatments.filter(t => t.id !== id);
            localStorage.setItem('treatments', JSON.stringify(treatments));
            displayTreatments();
            updateReports();
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FEED FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function addFeed(e) {
            e.preventDefault();
            
            const feed = {
                id: Date.now(),
                date: document.getElementById('feedDate').value,
                type: document.getElementById('feedType').value,
                quantity: document.getElementById('feedQuantity').value,
                cost: parseFloat(document.getElementById('feedCost').value),
                supplier: document.getElementById('feedSupplier').value,
                notes: document.getElementById('feedNotes').value
            };
            
            feedRecords.push(feed);
            localStorage.setItem('feedRecords', JSON.stringify(feedRecords));
            displayFeedRecords();
            updateReports();
            closeModal('addFeedModal');
            e.target.reset();
            document.getElementById('feedDate').value = new Date().toISOString().split('T')[0];
        }
        
        function displayFeedRecords() {
            const tbody = document.getElementById('feedTableBody');
            tbody.innerHTML = '';
            
            const total = feedRecords.reduce((sum, f) => sum + f.cost, 0);
            const active = goats.filter(g => g.status === 'Active').length;
            const perGoat = active > 0 ? total / active : 0;
            
            const now = new Date();
            const thisMonth = feedRecords.filter(f => {
                const d = new Date(f.date);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            }).reduce((sum, f) => sum + f.cost, 0);
            
            document.getElementById('feed-total').textContent = '$' + total.toFixed(2);
            document.getElementById('feed-per-goat').textContent = '$' + perGoat.toFixed(2);
            document.getElementById('feed-month').textContent = '$' + thisMonth.toFixed(2);
            
            feedRecords.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(f => {
                const row = tbody.insertRow();
                row.innerHTML = 
                    '<td>' + new Date(f.date).toLocaleDateString() + '</td>' +
                    '<td>' + f.type + '</td>' +
                    '<td>' + f.quantity + '</td>' +
                    '<td>$' + f.cost.toFixed(2) + '</td>' +
                    '<td>' + (f.supplier || '-') + '</td>' +
                    '<td>' + (f.notes || '-') + '</td>' +
                    '<td><button class="btn btn-danger btn-small" onclick="deleteFeed(' + f.id + ')">Delete</button></td>';
            });
        }
        
        function deleteFeed(id) {
            if (!confirm('Delete this feed record?')) return;
            feedRecords = feedRecords.filter(f => f.id !== id);
            localStorage.setItem('feedRecords', JSON.stringify(feedRecords));
            displayFeedRecords();
            updateReports();
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // KIDDING FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function openAddKiddingModal() {
            const doeSelect = document.getElementById('kiddingDoe');
            doeSelect.innerHTML = '<option value="">Select Doe</option>';
            
            goats.filter(g => g.gender === 'Doe').sort((a, b) => (a.name || a.tag).localeCompare(b.name || b.tag)).forEach(doe => {
                const option = document.createElement('option');
                option.value = doe.name || doe.tag;
                option.textContent = (doe.name || doe.tag) + ' (' + doe.tag + ')';
                doeSelect.appendChild(option);
            });
            
            const sireSelect = document.getElementById('kiddingSire');
            sireSelect.innerHTML = '<option value="">Unknown/Select Sire</option>';
            
            goats.filter(g => g.gender === 'Buck').sort((a, b) => (a.name || a.tag).localeCompare(b.name || b.tag)).forEach(buck => {
                const option = document.createElement('option');
                option.value = buck.name || buck.tag;
                option.textContent = (buck.name || buck.tag) + ' (' + buck.tag + ')';
                sireSelect.appendChild(option);
            });
            
            document.getElementById('kiddingDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('kiddingBucks').value = '0';
            document.getElementById('kiddingDoes').value = '0';
            document.getElementById('kiddingLitterSize').value = '0';
            document.getElementById('kiddingAutoAdd').checked = true;
            toggleKidTagInputs();
            document.getElementById('addKiddingModal').classList.add('active');
        }
        
        function toggleKidTagInputs() {
            const autoAdd = document.getElementById('kiddingAutoAdd').checked;
            document.getElementById('kiddingTagInputs').style.display = autoAdd ? 'block' : 'none';
            if (autoAdd) generateKidTagFields();
        }
        
        function updateLitterSize() {
            const bucks = parseInt(document.getElementById('kiddingBucks').value) || 0;
            const does = parseInt(document.getElementById('kiddingDoes').value) || 0;
            document.getElementById('kiddingLitterSize').value = bucks + does;
            if (document.getElementById('kiddingAutoAdd').checked) generateKidTagFields();
        }
        
        function generateKidTagFields() {
            const bucks = parseInt(document.getElementById('kiddingBucks').value) || 0;
            const does = parseInt(document.getElementById('kiddingDoes').value) || 0;
            const container = document.getElementById('kidTagFields');
            container.innerHTML = '';
            
            for (let i = 0; i < bucks; i++) {
                container.innerHTML += 
                    '<div style="margin-bottom: 20px; padding: 15px; background: #f0f7fc; border-radius: 8px; border: 2px solid #6ba3d4;">' +
                    '<h4 style="margin: 0 0 12px 0; color: var(--barn-red);">üêê Buck ' + (i + 1) + '</h4>' +
                    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">' +
                    '<div><label style="display: block; margin-bottom: 5px; font-weight: 600;">Tag Number *</label>' +
                    '<input type="text" class="kid-tag-input" data-gender="Buck" placeholder="e.g., 2025-B0' + (i + 1) + '" required style="padding: 10px; border: 2px solid var(--light-tan); border-radius: 6px; width: 100%; font-size: 16px;"></div>' +
                    '<div><label style="display: block; margin-bottom: 5px; font-weight: 600;">Color</label>' +
                    '<input type="text" class="kid-color-input" placeholder="e.g., Brown/White" style="padding: 10px; border: 2px solid var(--light-tan); border-radius: 6px; width: 100%; font-size: 16px;"></div></div>' +
                    '<div><label style="display: block; margin-bottom: 5px; font-weight: 600;">Birth Weight (lbs)</label>' +
                    '<input type="number" class="kid-weight-input" placeholder="e.g., 7.5" step="0.1" min="0" style="padding: 10px; border: 2px solid var(--light-tan); border-radius: 6px; width: 100%; font-size: 16px;"></div></div>';
            }
            
            for (let i = 0; i < does; i++) {
                container.innerHTML += 
                    '<div style="margin-bottom: 20px; padding: 15px; background: #fef5fa; border-radius: 8px; border: 2px solid #d98cb9;">' +
                    '<h4 style="margin: 0 0 12px 0; color: var(--barn-red);">üêê Doe ' + (i + 1) + '</h4>' +
                    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">' +
                    '<div><label style="display: block; margin-bottom: 5px; font-weight: 600;">Tag Number *</label>' +
                    '<input type="text" class="kid-tag-input" data-gender="Doe" placeholder="e.g., 2025-D0' + (i + 1) + '" required style="padding: 10px; border: 2px solid var(--light-tan); border-radius: 6px; width: 100%; font-size: 16px;"></div>' +
                    '<div><label style="display: block; margin-bottom: 5px; font-weight: 600;">Color</label>' +
                    '<input type="text" class="kid-color-input" placeholder="e.g., Brown/White" style="padding: 10px; border: 2px solid var(--light-tan); border-radius: 6px; width: 100%; font-size: 16px;"></div></div>' +
                    '<div><label style="display: block; margin-bottom: 5px; font-weight: 600;">Birth Weight (lbs)</label>' +
                    '<input type="number" class="kid-weight-input" placeholder="e.g., 6.5" step="0.1" min="0" style="padding: 10px; border: 2px solid var(--light-tan); border-radius: 6px; width: 100%; font-size: 16px;"></div></div>';
            }
        }
        
        function addKidding(e) {
            e.preventDefault();
            
            const kiddingDate = document.getElementById('kiddingDate').value;
            const doe = document.getElementById('kiddingDoe').value;
            const sire = document.getElementById('kiddingSire').value;
            const numBucks = parseInt(document.getElementById('kiddingBucks').value) || 0;
            const numDoes = parseInt(document.getElementById('kiddingDoes').value) || 0;
            const autoAdd = document.getElementById('kiddingAutoAdd').checked;
            const ease = parseInt(document.getElementById('kiddingEaseInput').value) || 3;
            
            const kidding = {
                id: Date.now(),
                date: kiddingDate,
                doe: doe,
                sire: sire,
                year: new Date(kiddingDate).getFullYear(),
                bucks: numBucks,
                does: numDoes,
                litterSize: numBucks + numDoes,
                ease: ease,
                notes: document.getElementById('kiddingNotes').value
            };
            
            kiddingRecords.push(kidding);
            localStorage.setItem('kiddingRecords', JSON.stringify(kiddingRecords));
            
            if (autoAdd && kidding.litterSize > 0) {
                const tagInputs = document.querySelectorAll('.kid-tag-input');
                const colorInputs = document.querySelectorAll('.kid-color-input');
                const weightInputs = document.querySelectorAll('.kid-weight-input');
                
                const tags = Array.from(tagInputs).map(input => input.value.trim()).filter(tag => tag !== '');
                
                if (tags.length !== kidding.litterSize) {
                    alert('Please enter tag numbers for all ' + kidding.litterSize + ' kid(s)');
                    return;
                }
                
                const existingTags = goats.map(g => g.tag);
                const duplicates = tags.filter(tag => existingTags.includes(tag));
                if (duplicates.length > 0) {
                    alert('These tag numbers already exist: ' + duplicates.join(', '));
                    return;
                }
                
                let kidIndex = 0;
                
                for (let i = 0; i < numBucks; i++) {
                    const tag = tags[kidIndex];
                    const color = colorInputs[kidIndex].value.trim();
                    const birthWeight = weightInputs[kidIndex].value.trim();
                    kidIndex++;
                    
                    const kid = {
                        id: Date.now() + i,
                        photo: null,
                        name: tag,
                        tag: tag,
                        status: 'Active',
                        gender: 'Buck',
                        birthDate: kiddingDate,
                        sire: sire || '',
                        dam: doe,
                        color: color || '',
                        weanedDate: '',
                        kiddingEase: ease.toString(),
                        badFeet: false, poorUdder: false, kidsPoorly: false, digestive: false,
                        notes: 'Born from ' + doe + (sire ? ' x ' + sire : '') + '. Kidding ease: ' + ease + '/5' + (birthWeight ? '. Birth weight: ' + birthWeight + ' lbs' : ''),
                        salePrice: '', cullDate: '', cullReason: '',
                        weights: birthWeight ? [{ id: Date.now() + i, date: kiddingDate, weight: parseFloat(birthWeight), bodyCondition: '', notes: 'Birth weight' }] : []
                    };
                    goats.push(kid);
                }
                
                for (let i = 0; i < numDoes; i++) {
                    const tag = tags[kidIndex];
                    const color = colorInputs[kidIndex].value.trim();
                    const birthWeight = weightInputs[kidIndex].value.trim();
                    kidIndex++;
                    
                    const kid = {
                        id: Date.now() + numBucks + i,
                        photo: null,
                        name: tag,
                        tag: tag,
                        status: 'Active',
                        gender: 'Doe',
                        birthDate: kiddingDate,
                        sire: sire || '',
                        dam: doe,
                        color: color || '',
                        weanedDate: '',
                        kiddingEase: ease.toString(),
                        badFeet: false, poorUdder: false, kidsPoorly: false, digestive: false,
                        notes: 'Born from ' + doe + (sire ? ' x ' + sire : '') + '. Kidding ease: ' + ease + '/5' + (birthWeight ? '. Birth weight: ' + birthWeight + ' lbs' : ''),
                        salePrice: '', cullDate: '', cullReason: '',
                        weights: birthWeight ? [{ id: Date.now() + numBucks + i, date: kiddingDate, weight: parseFloat(birthWeight), bodyCondition: '', notes: 'Birth weight' }] : []
                    };
                    goats.push(kid);
                }
                
                localStorage.setItem('goats', JSON.stringify(goats));
                displayGoats();
                updateStats();
                renderFamilyTree();
                populateYearFilter();
            }
            
            displayKiddingRecords();
            updateKiddingStats();
            populateKiddingFilters();
            closeModal('addKiddingModal');
            e.target.reset();
        }
        
        function displayKiddingRecords() {
            const tbody = document.getElementById('kiddingTableBody');
            tbody.innerHTML = '';
            
            const doeFilter = document.getElementById('kiddingDoeFilter')?.value || '';
            const yearFilter = document.getElementById('kiddingYearFilter')?.value || '';
            
            let filtered = kiddingRecords;
            if (doeFilter) filtered = filtered.filter(k => k.doe === doeFilter);
            if (yearFilter) filtered = filtered.filter(k => k.year.toString() === yearFilter);
            
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(k => {
                let sizeType = 'Single';
                if (k.litterSize === 2) sizeType = 'Twins';
                else if (k.litterSize >= 3) sizeType = 'Triplets+';
                
                const row = tbody.insertRow();
                row.innerHTML = 
                    '<td>' + new Date(k.date).toLocaleDateString() + '</td>' +
                    '<td><strong>' + k.doe + '</strong></td>' +
                    '<td>' + (k.sire || 'Unknown') + '</td>' +
                    '<td>' + k.year + '</td>' +
                    '<td><span class="badge badge-active">' + k.litterSize + ' (' + sizeType + ')</span></td>' +
                    '<td>' + k.bucks + '</td>' +
                    '<td>' + k.does + '</td>' +
                    '<td>' + k.ease + '/5</td>' +
                    '<td>' + (k.notes || '-') + '</td>' +
                    '<td><button class="btn btn-danger btn-small" onclick="deleteKidding(' + k.id + ')">Delete</button></td>';
            });
            
            updateDoePerformance();
        }
        
        function updateDoePerformance() {
            const tbody = document.getElementById('doePerformanceBody');
            tbody.innerHTML = '';
            
            const doeStats = {};
            
            kiddingRecords.forEach(k => {
                if (!doeStats[k.doe]) doeStats[k.doe] = { total: 0, totalSize: 0, singles: 0, twins: 0, triplets: 0, totalEase: 0 };
                doeStats[k.doe].total++;
                doeStats[k.doe].totalSize += k.litterSize;
                doeStats[k.doe].totalEase += k.ease;
                if (k.litterSize === 1) doeStats[k.doe].singles++;
                else if (k.litterSize === 2) doeStats[k.doe].twins++;
                else if (k.litterSize >= 3) doeStats[k.doe].triplets++;
            });
            
            Object.keys(doeStats).sort().forEach(doe => {
                const stats = doeStats[doe];
                const row = tbody.insertRow();
                row.innerHTML = 
                    '<td><strong>' + doe + '</strong></td>' +
                    '<td>' + stats.total + '</td>' +
                    '<td>' + (stats.totalSize / stats.total).toFixed(1) + '</td>' +
                    '<td>' + stats.singles + '</td>' +
                    '<td>' + stats.twins + '</td>' +
                    '<td>' + stats.triplets + '</td>' +
                    '<td>' + (stats.totalEase / stats.total).toFixed(1) + '/5</td>';
            });
            
            if (Object.keys(doeStats).length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No kidding records yet</td></tr>';
            }
        }
        
        function updateKiddingStats() {
            const total = kiddingRecords.length;
            const totalSize = kiddingRecords.reduce((sum, k) => sum + k.litterSize, 0);
            const avgSize = total > 0 ? (totalSize / total).toFixed(2) : 0;
            
            const singles = kiddingRecords.filter(k => k.litterSize === 1).length;
            const twins = kiddingRecords.filter(k => k.litterSize === 2).length;
            const triplets = kiddingRecords.filter(k => k.litterSize >= 3).length;
            
            document.getElementById('kidding-total').textContent = total;
            document.getElementById('kidding-avg').textContent = avgSize;
            document.getElementById('kidding-singles').textContent = (total > 0 ? ((singles / total) * 100).toFixed(0) : 0) + '%';
            document.getElementById('kidding-twins').textContent = (total > 0 ? ((twins / total) * 100).toFixed(0) : 0) + '%';
            document.getElementById('kidding-triplets').textContent = (total > 0 ? ((triplets / total) * 100).toFixed(0) : 0) + '%';
        }
        
        function populateKiddingFilters() {
            const doeFilter = document.getElementById('kiddingDoeFilter');
            if (doeFilter) {
                const currentDoe = doeFilter.value;
                doeFilter.innerHTML = '<option value="">All Does</option>';
                [...new Set(kiddingRecords.map(k => k.doe))].sort().forEach(doe => {
                    const option = document.createElement('option');
                    option.value = doe;
                    option.textContent = doe;
                    doeFilter.appendChild(option);
                });
                doeFilter.value = currentDoe;
            }
            
            const yearFilter = document.getElementById('kiddingYearFilter');
            if (yearFilter) {
                const currentYear = yearFilter.value;
                yearFilter.innerHTML = '<option value="">All Years</option>';
                [...new Set(kiddingRecords.map(k => k.year))].sort((a, b) => b - a).forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearFilter.appendChild(option);
                });
                yearFilter.value = currentYear;
            }
        }
        
        function deleteKidding(id) {
            if (!confirm('Delete this kidding record?')) return;
            kiddingRecords = kiddingRecords.filter(k => k.id !== id);
            localStorage.setItem('kiddingRecords', JSON.stringify(kiddingRecords));
            displayKiddingRecords();
            updateKiddingStats();
            populateKiddingFilters();
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FAMILY TREE FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function renderFamilyTree() {
            const container = document.getElementById('familyTreeContainer');
            if (!container) return;
            
            const filter = document.getElementById('treeViewFilter')?.value || 'all';
            
            let filteredGoats = goats;
            if (filter === 'does') filteredGoats = goats.filter(g => g.gender === 'Doe');
            else if (filter === 'bucks') filteredGoats = goats.filter(g => g.gender === 'Buck');
            
            const foundationAnimals = filteredGoats.filter(g => !g.sire && !g.dam);
            const descendants = filteredGoats.filter(g => g.sire || g.dam);
            
            let html = '';
            
            if (foundationAnimals.length > 0) {
                html += '<h3 class="section-title foundation">Foundation Animals</h3>';
                foundationAnimals.forEach(goat => html += renderGoatNode(goat));
            }
            
            const grouped = {};
            descendants.forEach(goat => {
                const parentKey = (goat.sire || 'Unknown') + '_' + (goat.dam || 'Unknown');
                if (!grouped[parentKey]) grouped[parentKey] = [];
                grouped[parentKey].push(goat);
            });
            
            if (Object.keys(grouped).length > 0) {
                html += '<h3 class="section-title family-groups">Family Groups</h3>';
                Object.keys(grouped).forEach(parentKey => {
                    const [sire, dam] = parentKey.split('_');
                    html += '<div class="tree-view-container">';
                    html += '<h4>Sire: ' + sire + ' | Dam: ' + dam + '</h4>';
                    html += '<div class="tree-children">';
                    grouped[parentKey].forEach(kid => html += renderGoatNode(kid));
                    html += '</div></div>';
                });
            }
            
            if (html === '') {
                html = '<p style="text-align: center; color: #666; padding: 40px;">No goats in the system yet.</p>';
            }
            
            container.innerHTML = html;
        }
        
        function renderGoatNode(goat) {
            const age = calculateAge(goat.birthDate);
            const offspring = goats.filter(g => g.sire === (goat.name || goat.tag) || g.dam === (goat.name || goat.tag));
            
            const genderClass = goat.gender.toLowerCase();
            const genderIcon = goat.gender === 'Doe' ? '‚ôÄ' : goat.gender === 'Buck' ? '‚ôÇ' : '‚ö•';
            
            let html = '<div class="tree-node" data-gender="' + goat.gender + '" onclick="viewGoatDetails(' + goat.id + ')">';
            if (goat.photo) html += '<img src="' + goat.photo + '" class="goat-photo-small" style="float: left; margin-right: 15px;">';
            html += '<div class="tree-node-name">' + (goat.name || goat.tag) + ' (' + goat.tag + ')</div>';
            html += '<div class="tree-node-details">';
            html += '<span class="gender-badge ' + genderClass + '">' + genderIcon + ' ' + goat.gender + '</span>';
            html += '<span>üìÖ ' + age + '</span>';
            html += '<span>' + goat.status + '</span>';
            if (offspring.length > 0) html += '<span class="offspring-count">üë∂ ' + offspring.length + ' offspring</span>';
            html += '</div><div style="clear: both;"></div></div>';
            
            if (offspring.length > 0) {
                html += '<div class="tree-children">';
                offspring.forEach(kid => html += renderGoatNode(kid));
                html += '</div>';
            }
            
            return html;
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // BULK SALE FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function openBulkSaleModal() {
            const activeGoats = goats.filter(g => g.status === 'Active');
            
            if (activeGoats.length === 0) {
                alert('No active goats to sell!');
                return;
            }
            
            const listDiv = document.getElementById('bulkSaleGoatList');
            listDiv.innerHTML = '';
            
            activeGoats.forEach(g => {
                listDiv.innerHTML += 
                    '<div style="padding: 12px; margin-bottom: 8px; background: white; border-radius: 6px; border: 2px solid var(--light-tan); display: flex; align-items: center; gap: 12px;">' +
                    '<input type="checkbox" id="bulk-' + g.id + '" value="' + g.id + '" onchange="updateBulkSaleCalculation()" style="width: 20px; height: 20px; cursor: pointer;">' +
                    '<label for="bulk-' + g.id + '" style="margin: 0; cursor: pointer; flex: 1;">' +
                    '<strong>' + (g.name || g.tag) + '</strong> (' + g.tag + ') - ' + g.gender + '</label></div>';
            });
            
            document.getElementById('bulkSaleDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('bulkSaleTotal').value = '';
            document.getElementById('bulkSaleNotes').value = '';
            updateBulkSaleCalculation();
            document.getElementById('bulkSaleModal').classList.add('active');
        }
        
        function updateBulkSaleCalculation() {
            const checkboxes = document.querySelectorAll('#bulkSaleGoatList input[type="checkbox"]:checked');
            const count = checkboxes.length;
            const total = parseFloat(document.getElementById('bulkSaleTotal').value) || 0;
            const perGoat = count > 0 ? (total / count) : 0;
            
            document.getElementById('bulkSaleCount').textContent = count;
            document.getElementById('bulkSalePerGoat').textContent = perGoat.toFixed(2);
        }
        
        function processBulkSale(e) {
            e.preventDefault();
            
            const checkboxes = document.querySelectorAll('#bulkSaleGoatList input[type="checkbox"]:checked');
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (selectedIds.length === 0) {
                alert('Please select at least one goat to sell');
                return false;
            }
            
            const total = parseFloat(document.getElementById('bulkSaleTotal').value);
            const notes = document.getElementById('bulkSaleNotes').value;
            const pricePerGoat = total / selectedIds.length;
            
            if (!confirm('Sell ' + selectedIds.length + ' goats for $' + total.toFixed(2) + ' ($' + pricePerGoat.toFixed(2) + ' each)?')) {
                return false;
            }
            
            selectedIds.forEach(id => {
                const goat = goats.find(g => g.id === id);
                if (goat) {
                    goat.status = 'Sold';
                    goat.salePrice = pricePerGoat.toFixed(2);
                    if (notes) goat.notes = goat.notes ? goat.notes + '\n\nSale: ' + notes : 'Sale: ' + notes;
                }
            });
            
            localStorage.setItem('goats', JSON.stringify(goats));
            displayGoats();
            updateStats();
            updateReports();
            renderFamilyTree();
            closeModal('bulkSaleModal');
            
            alert('Successfully sold ' + selectedIds.length + ' goats for $' + total.toFixed(2) + '!');
            return false;
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STATS AND REPORTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function updateStats() {
            const active = goats.filter(g => g.status === 'Active').length;
            const does = goats.filter(g => g.status === 'Active' && g.gender === 'Doe').length;
            const bucks = goats.filter(g => g.status === 'Active' && g.gender === 'Buck').length;
            const wethers = goats.filter(g => g.status === 'Active' && g.gender === 'Wether').length;
            
            document.getElementById('stat-active').textContent = active;
            document.getElementById('stat-does').textContent = does;
            document.getElementById('stat-bucks').textContent = bucks;
            document.getElementById('stat-wethers').textContent = wethers;
        }
        
        function populateYearFilter() {
            const select = document.getElementById('yearFilter');
            if (!select) return;
            const years = new Set(goats.filter(g => g.birthDate).map(g => new Date(g.birthDate).getFullYear()));
            const currentOptions = Array.from(select.options).slice(1).map(o => o.value);
            
            Array.from(years).sort((a, b) => b - a).forEach(year => {
                if (!currentOptions.includes(year.toString())) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    select.appendChild(option);
                }
            });
        }
        
        function monthsSince(dateString) {
            const birth = new Date(dateString);
            const today = new Date();
            return (today.getFullYear() - birth.getFullYear()) * 12 + (today.getMonth() - birth.getMonth());
        }
        
        function updateReports() {
            const soldGoats = goats.filter(g => g.status === 'Sold' && g.salePrice);
            const activeGoats = goats.filter(g => g.status === 'Active');
            const culledGoats = goats.filter(g => g.status === 'Culled');
            const totalGoats = goats.length;
            
            const totalSales = soldGoats.reduce((sum, g) => sum + parseFloat(g.salePrice || 0), 0);
            const totalFeed = feedRecords.reduce((sum, f) => sum + f.cost, 0);
            const totalTreatment = treatments.reduce((sum, t) => sum + parseFloat(t.cost || 0), 0);
            const netProfit = totalSales - totalFeed - totalTreatment;
            
            document.getElementById('report-sales').textContent = '$' + totalSales.toFixed(2);
            document.getElementById('report-feed').textContent = '$' + totalFeed.toFixed(2);
            document.getElementById('report-treatment').textContent = '$' + totalTreatment.toFixed(2);
            document.getElementById('report-net').textContent = '$' + netProfit.toFixed(2);
            document.getElementById('report-net').style.color = netProfit >= 0 ? '#155724' : '#721c24';
            
            const avgSale = soldGoats.length > 0 ? totalSales / soldGoats.length : 0;
            const retentionRate = totalGoats > 0 ? (activeGoats.length / totalGoats) * 100 : 0;
            const cullRate = totalGoats > 0 ? (culledGoats.length / totalGoats) * 100 : 0;
            
            document.getElementById('report-avg-sale').textContent = '$' + avgSale.toFixed(2);
            document.getElementById('report-total-ever').textContent = totalGoats;
            document.getElementById('report-retention').textContent = retentionRate.toFixed(1) + '%';
            document.getElementById('report-cull-rate').textContent = cullRate.toFixed(1) + '%';
            
            const feedPerGoat = activeGoats.length > 0 ? totalFeed / activeGoats.length : 0;
            const treatmentPerGoat = activeGoats.length > 0 ? totalTreatment / activeGoats.length : 0;
            
            document.getElementById('report-feed-per-goat').textContent = '$' + feedPerGoat.toFixed(2);
            document.getElementById('report-treatment-per-goat').textContent = '$' + treatmentPerGoat.toFixed(2);
            document.getElementById('report-total-per-goat').textContent = '$' + (feedPerGoat + treatmentPerGoat).toFixed(2);
            
            const now = new Date();
            const monthlyFeed = feedRecords.filter(f => {
                const d = new Date(f.date);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            }).reduce((sum, f) => sum + f.cost, 0);
            document.getElementById('report-monthly-feed').textContent = '$' + monthlyFeed.toFixed(2);
            
            // Gender breakdown
            const bucks = activeGoats.filter(g => g.gender === 'Buck').length;
            const does = activeGoats.filter(g => g.gender === 'Doe').length;
            const wethers = activeGoats.filter(g => g.gender === 'Wether').length;
            document.getElementById('gender-breakdown').innerHTML = 
                '<div style="margin-bottom: 8px;">Bucks: <strong>' + bucks + '</strong></div>' +
                '<div style="margin-bottom: 8px;">Does: <strong>' + does + '</strong></div>' +
                '<div>Wethers: <strong>' + wethers + '</strong></div>';
            
            // Age breakdown
            const kids = activeGoats.filter(g => g.birthDate && monthsSince(g.birthDate) < 12).length;
            const yearlings = activeGoats.filter(g => g.birthDate && monthsSince(g.birthDate) >= 12 && monthsSince(g.birthDate) < 24).length;
            const adults = activeGoats.filter(g => g.birthDate && monthsSince(g.birthDate) >= 24).length;
            document.getElementById('age-breakdown').innerHTML = 
                '<div style="margin-bottom: 8px;">Kids (&lt;1yr): <strong>' + kids + '</strong></div>' +
                '<div style="margin-bottom: 8px;">Yearlings (1-2yr): <strong>' + yearlings + '</strong></div>' +
                '<div>Adults (2+yr): <strong>' + adults + '</strong></div>';
            
            // Health breakdown
            document.getElementById('health-breakdown').innerHTML = 
                '<div style="margin-bottom: 8px;">Bad Feet: <strong>' + activeGoats.filter(g => g.badFeet).length + '</strong></div>' +
                '<div style="margin-bottom: 8px;">Poor Udder: <strong>' + activeGoats.filter(g => g.poorUdder).length + '</strong></div>' +
                '<div style="margin-bottom: 8px;">Kids Poorly: <strong>' + activeGoats.filter(g => g.kidsPoorly).length + '</strong></div>' +
                '<div>Digestive Issues: <strong>' + activeGoats.filter(g => g.digestive).length + '</strong></div>';
            
            // Breeding performance
            const breedingBody = document.getElementById('breedingTableBody');
            breedingBody.innerHTML = '';
            const dams = {};
            goats.forEach(g => {
                if (g.dam) {
                    if (!dams[g.dam]) dams[g.dam] = { kids: [], kiddingEases: [] };
                    dams[g.dam].kids.push(g);
                    if (g.kiddingEase) dams[g.dam].kiddingEases.push(parseInt(g.kiddingEase));
                }
            });
            
            Object.keys(dams).sort().forEach(dam => {
                const data = dams[dam];
                const row = breedingBody.insertRow();
                row.innerHTML = 
                    '<td><strong>' + dam + '</strong></td>' +
                    '<td>' + data.kids.length + '</td>' +
                    '<td>' + (data.kiddingEases.length > 0 ? (data.kiddingEases.reduce((a,b) => a+b, 0) / data.kiddingEases.length).toFixed(1) : 'N/A') + '</td>' +
                    '<td>' + data.kids.filter(k => k.status === 'Active').length + '</td>' +
                    '<td>' + data.kids.filter(k => k.status === 'Sold').length + '</td>';
            });
            
            if (Object.keys(dams).length === 0) breedingBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #666;">No breeding records yet</td></tr>';
            
            // Sales stats
            document.getElementById('sales-total-count').textContent = soldGoats.length;
            document.getElementById('sales-bucks').textContent = soldGoats.filter(g => g.gender === 'Buck').length;
            document.getElementById('sales-does').textContent = soldGoats.filter(g => g.gender === 'Doe').length;
            const avgAgeMonths = soldGoats.length > 0 ? soldGoats.reduce((sum, g) => sum + (g.birthDate ? monthsSince(g.birthDate) : 0), 0) / soldGoats.length : 0;
            document.getElementById('sales-avg-age').textContent = avgAgeMonths < 12 ? avgAgeMonths.toFixed(0) + ' mo' : (avgAgeMonths / 12).toFixed(1) + ' yr';
            
            // Sales table
            const salesBody = document.getElementById('salesTableBody');
            salesBody.innerHTML = '';
            soldGoats.forEach(g => {
                const row = salesBody.insertRow();
                row.innerHTML = 
                    '<td>' + (g.name || g.tag) + '</td>' +
                    '<td>' + g.tag + '</td>' +
                    '<td>' + g.gender + '</td>' +
                    '<td>' + (g.birthDate ? new Date(g.birthDate).toLocaleDateString() : 'N/A') + '</td>' +
                    '<td><strong>$' + parseFloat(g.salePrice).toFixed(2) + '</strong></td>' +
                    '<td>' + calculateAge(g.birthDate) + '</td>';
            });
            if (soldGoats.length === 0) salesBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No sales recorded yet</td></tr>';
            
            // Treatment analysis
            const treatmentTypes = {};
            treatments.forEach(t => treatmentTypes[t.type] = (treatmentTypes[t.type] || 0) + 1);
            const mostCommon = Object.keys(treatmentTypes).length > 0 ? Object.keys(treatmentTypes).reduce((a, b) => treatmentTypes[a] > treatmentTypes[b] ? a : b) : '-';
            
            document.getElementById('treatment-count').textContent = treatments.length;
            document.getElementById('treatment-common').textContent = mostCommon;
            document.getElementById('treatment-avg-cost').textContent = '$' + (treatments.length > 0 ? (totalTreatment / treatments.length).toFixed(2) : '0.00');
            
            // Culled table
            const culledBody = document.getElementById('culledTableBody');
            culledBody.innerHTML = '';
            culledGoats.forEach(g => {
                const row = culledBody.insertRow();
                row.innerHTML = 
                    '<td>' + (g.name || g.tag) + '</td>' +
                    '<td>' + g.tag + '</td>' +
                    '<td>' + g.gender + '</td>' +
                    '<td>' + (g.cullDate ? new Date(g.cullDate).toLocaleDateString() : 'N/A') + '</td>' +
                    '<td>' + (g.cullReason || '-') + '</td>' +
                    '<td>' + calculateAge(g.birthDate) + '</td>';
            });
            if (culledGoats.length === 0) culledBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No culled animals</td></tr>';
            
            // Year costs
            const yearCosts = {};
            feedRecords.forEach(f => {
                const year = new Date(f.date).getFullYear();
                if (!yearCosts[year]) yearCosts[year] = { feed: 0, treatment: 0, sales: 0 };
                yearCosts[year].feed += f.cost;
            });
            treatments.forEach(t => {
                const year = new Date(t.date).getFullYear();
                if (!yearCosts[year]) yearCosts[year] = { feed: 0, treatment: 0, sales: 0 };
                yearCosts[year].treatment += parseFloat(t.cost || 0);
            });
            soldGoats.forEach(g => {
                const year = new Date().getFullYear();
                if (!yearCosts[year]) yearCosts[year] = { feed: 0, treatment: 0, sales: 0 };
                yearCosts[year].sales += parseFloat(g.salePrice || 0);
            });
            
            const yearBody = document.getElementById('yearCostsTableBody');
            yearBody.innerHTML = '';
            Object.keys(yearCosts).sort((a, b) => b - a).forEach(year => {
                const total = yearCosts[year].feed + yearCosts[year].treatment;
                const net = yearCosts[year].sales - total;
                const row = yearBody.insertRow();
                row.innerHTML = 
                    '<td><strong>' + year + '</strong></td>' +
                    '<td>$' + yearCosts[year].feed.toFixed(2) + '</td>' +
                    '<td>$' + yearCosts[year].treatment.toFixed(2) + '</td>' +
                    '<td><strong>$' + total.toFixed(2) + '</strong></td>' +
                    '<td><strong>$' + yearCosts[year].sales.toFixed(2) + '</strong></td>' +
                    '<td style="color: ' + (net >= 0 ? '#155724' : '#721c24') + '"><strong>$' + net.toFixed(2) + '</strong></td>';
            });
            if (Object.keys(yearCosts).length === 0) yearBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No cost records yet</td></tr>';
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EXPORT FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function exportGoatRegistry() {
            let csv = 'Name,Tag,Status,Gender,Birth Date,Sire,Dam,Color,Notes\n';
            goats.forEach(g => {
                csv += '"' + (g.name || '') + '","' + g.tag + '","' + g.status + '","' + g.gender + '","' + 
                       (g.birthDate || '') + '","' + (g.sire || '') + '","' + (g.dam || '') + '","' + 
                       (g.color || '') + '","' + (g.notes || '').replace(/"/g, '""') + '"\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'goat-registry-' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        function exportReport() {
            let csv = 'Grass and Grit Farms - Herd Report\n\n';
            csv += 'ACTIVE HERD\nName,Tag,Gender,Birth Date,Color\n';
            goats.filter(g => g.status === 'Active').forEach(g => {
                csv += '"' + (g.name || g.tag) + '","' + g.tag + '","' + g.gender + '","' + (g.birthDate || '') + '","' + (g.color || '') + '"\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'goat-report-' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
